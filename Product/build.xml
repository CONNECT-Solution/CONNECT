<?xml version="1.0" encoding="UTF-8"?>
<project name="NHINC" basedir=".">

    <import file="build/build.targets.xml"/>
    <import file="dist.targets.xml"/>

    <condition property="progress-filepath" value="${temp.directory.path}/ant-progress.txt">
        <not>
            <isset property="progress-filepath" />
        </not>
    </condition>

    <target name="package.create" description="Create the jar|war|ear for all projects: run ant help for more info...">
        <var name="do-to-target" value="just.package.create" />
        <antcall target="do-to-projects" />
    </target>

    <target name="quick.package.create">
        <var name="do-to-target" value="just.quick.package.create" />
        <antcall target="do-to-projects" />
    </target>

    <target name="deploy" depends="copy.deployable.artifacts" description="Deploy all projects: run ant help for more info...">
        <call target="deploy.to.production"/>
    </target>

    <target name="copy.deployable.artifacts">
        <delete dir="${deployment.binaries.dir}"/>
        <mkdir dir="${deployment.binaries.dir}"/>
        <delete dir="${deployment.dir}/ValidationSuite"/>
        <mkdir dir="${deployment.dir}/ValidationSuite"/>
        <runtarget target="create.deploy.list.xml"/>

        <copy todir="${deployment.dir}/${deployment.environment.configuration.dir.name}" verbose="true" overwrite="true">
            <fileset dir="${root.project.directory.path}/Production/Common/Properties/${deployment.environment.configuration.dir.name}"/>
        </copy>

        <copy todir="${deployment.interfaces.dir}" verbose="true" overwrite="true">
            <fileset dir="${root.project.directory.path}/Production/Common/Interfaces/src"/>
        </copy>

        <copy todir="${deployment.dir}/ValidationSuite" verbose="true" overwrite="true">
            <fileset dir="${root.project.directory.path}/SoapUI_Test/ValidationSuite" />
        </copy>

        <var name="do-to-target" value="copy.deployable.artifacts"/>
        <antcall target="do-to-projects"/>
    </target>

    <target name="do-to-projects" unless="skip.do-to-projects" description="calls the target specified in the property do-to-target on all the projects.">
        <property name="current.project.count" value="0" />
        <xmltask source="${basedir}/projects.xml">
            <call path="/projects/project">
                <param name="project.name" path="name/text()" />
                <param name="project.directory" path="directory/text()" />
                <param name="should.build" path="should.build/text()" />
                <actions>
                    <if>
                        <istrue value="@{should.build}"/>
                        <then>
                            <math result="current.project.count" operand1="${current.project.count}" operation="+" operand2="1" datatype="int" />
                            <echo message=" ******************** Start @{project.name} ${do-to-target} project ${current.project.count} of ${to.build.count} *************************" file="${progress-filepath}" level="info"/>
                            <echo message=" ******************** Start @{project.name} ${do-to-target} project ${current.project.count} of ${to.build.count} *************************" level="info"/>
                            <project name="@{project.name}" dir="${basedir}/@{project.directory}" file="build.xml" target="${do-to-target}" order="${current.project.count}"/>
                            <echo message=" ******************** End @{project.name} ${do-to-target} project ${current.project.count} of ${to.build.count} *************************" file="${progress-filepath}" level="info"/>
                            <echo message=" ******************** End @{project.name} ${do-to-target} project ${current.project.count} of ${to.build.count} *************************" level="info"/>
                        </then>
                    </if>
                </actions>
            </call>
        </xmltask>
    </target>
</project>
